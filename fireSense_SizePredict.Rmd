---
title: "fireSense_SizePredict"
author: "Jean Marchal"
date: "August 2016"
output:
  html_document: default
  pdf_document: default
---

# Overview
Predict the shape and taper parameters of the tapered Pareto from a model fitted using fireSense_SizeFit.

# Download the module
```{r download module, eval = FALSE, echo = TRUE}
library(SpaDES)

moduleName <- "fireSense_SizePredict"

workingDirectory <- tempdir() # Change this to a place you would like to put the module, if desired.

downloadModule(moduleName, path = workingDirectory)
```

# Usage
## Module parameters
Name|Default|Description
----|:-------:|---------------------------------------------------------------------
`data`|`NULL`|optional. A `character vector` indicating the names of objects in the `simList` environment in which to look for variables in the model. Data objects can be `data.frames` or named `list` of `RasterLayers` but should all be of one unique class, e.g. `RasterLayer`. If omitted, or if variables are not found in data objects, variables are searched in the `simList` environment.
`mapping`|`NULL`|optional. Named `character vector` or `list` mapping some or all variables in the model to those in data objects.
`initialRunTime`|`start(sim)`|optional. Simulation time at which to start this module. Defaults to simulation start time.
`intervalRunModule`|`NA`|optional. Interval in simulation time units between two runs of this module.

## Usage example
```{r module usage example, eval = FALSE}
library(SpaDES)
library(PtProcess)

# Packages required by the module
library(magrittr)
library(raster)

set.seed(1)

# Create random weather and fire size data
  # data.frame
  dataObject <- data.frame(
    weather = rnorm(1000, 150, 30),
    size_ha = rtappareto(1000, .3, 1e4, a = 1)
  )

  # raster
  nx <- ny <- 100L
  size_ha <- raster(nrows = ny, ncols = nx, xmn = -nx/2, xmx = nx/2, ymn = -ny/2, ymx = ny/2) %>%
    setValues(rtappareto(ncell(.), .3, 1e4, a = 1))
  weather <- gaussMap(size_ha, scale = 300, var = 0.03, speedup = nx/5e2, inMemory = TRUE)
  dataObject <- list(weather = weather, size_ha = size_ha)
  
# Create a typical output of fireSense_SizeFit
fireSense_SizeFitted <- list(
  formula = list(beta = size_ha ~ weather2,
                 theta = size_ha ~ weather),
  link = list(beta = make.link("log"),
              theta = make.link("identity"))
  coef = list(beta = setNames(c(1, 0.01), c("intercept", "weather2")),
              theta = setNames(c(1, 0.001), c("intercept", "weather")))
)
class(fireSense_SizeFitted) <- "fireSense_SizeFit"

#outputDir <- file.path(tempdir(), "outputs")
times <- list(start = 1, end = 1, timeunit = "year")
parameters <- list(
  fireSense_SizePredict = list(
    mapping = list(weather2 = "weather"), # One can use mapping to map variables in the 
                                          # formula of the fitted object to those in data.
                                          # Here weather2 (formula) is mapped to weather (data).
    data = "dataObject"
  )
)

modules <- list("fireSense_SizePredict")
objects <- c("dataObject", "fireSense_SizeFitted") # Pass objects found in the global environment to the simList environment
paths <- list(
  # cachePath = file.path(outputDir, "cache"),
  modulePath = file.path("~/Documents/GitHub/McIntire-lab/modulesPrivate/") ## TODO: change this to tempdir()
  # inputPath = inputDir,
  # outputPath = outputDir
)
 
mySim <- simInit(times = times, params = parameters, modules = modules, objects = objects, paths = paths)

spades(mySim)
```

# Events
Events are scheduled as follows:

- Module initiation
- Make predictions

## Saving
TODO: Write what is saved. (there is currently nothing saved, but this may change in the future)

# Data dependencies
## Input data
- An object of class `fireSense_SizeFit`, i.e. created with the fireSense_SizeFit module.
- An or several objects of class `data.frame`, or named lists of `RasterLayer` in which to look for variables with which to predict.

## Output data
An object whose class depends on those in input:

Input object class | Output object class
:-:|:-:
`data.frame` | `numeric`
`RasterLayer` | `RasterLayer`
||

# Links to other modules
Predictions made with this module reflect the temporal and spatial heterogeneity found in environmental controls of fire spread. These can be used in simulation models sampling fire sizes from a tapered Pareto distribution, or to derive probability surfaces of spread probabilities (e.g. fireSense_SpreadPredict in association with fireSense_SpreadFit).

